\section{Passage de IPv4 à IPv6}
\subsection{Raison du passage de IPv4 à IPv6}
\subsubsection{Problème posé par IPv4}
//Pénrurie, adressage privé/publique compliqué
% Il se trouve que apparement il y a des problemes de
% penurie d'adresses meme dans certaines reseau prive`
% http://blog.erratasec.com/2013/12/dod-address-space-its-not-conspiracy.html#.WAf_d7Wf21F

PROBLÈMES DE IPV4

ÉPUISEMENT DES ADRESSES
Lorsque IPV4 a été développé dans les années 70-début des années 80, personnes 
n'aurait imaginé qu'il y aurait un jour autant d'interfaces qui se connectent à
Internet. On pensait qu'une adresse sur 32 bits serait suffisante. De plus, les
plages d'adresses étaient distribuées généreusement au début. Cela veut dire
que l'on attribuait des adresses permettant un nombre d'interfaces beaucoup 
plus grand que nécessaire.
Cependant, avec la croissance du nombre d'utilisateurs, la plage d'adresses
IPV4 disponible a diminué progressivement. C'est en février 2011 que la réserve
de bloc libres d'adresses publics IPV4 de l'IANA (Internet Assigned Numbers 
Authority) est arrivée à épuisement.

Afin de résoudre ce problème, plusieurs techniques ont été proposées.
La première a été le changement de teechnique d'adressage. On est passé de la
technique de classe d'adressage IP à la technique Classless Inter-Domain
Routing. Ceci à permis une meilleure efficacité dans la distribution des
adresses IP grâce à la création de réseau de tailles intermédiaire. En effet,
avant on ne disposait que de réseau de 3 tailles différentes.

Les politiques d'assignement d'adresses ont également été rendu plus stricte
afin de mieux tenir compte des besoin réels des demandeurs d'adresses IP.

Il a aussi été décidé d'utiliser des blocs autrefois réservé comme 14.0.0.0.

Sur base de volontarisme, des blocs autrefois attribués généreusement ou alors
des IP non utilisées ont été récupérées.

Finalement, il a été remarqué qu'il n'était pas nécessaire que chaque interface
a son adresse IP public et le protocole NAT a été développé afin de regrouper
plusieurs interface sous une même adresse IP. Ce protocole est de plus en plus
utilisé dans IPV4 depuis la fin des années 90.


Fonctionnement du NAT dynamique (Network Adress Translation)
Le NAT est une technique utilisée au niveau du routeur. Le principe du NAT est
que le routeur fait correspondre à une adresse IP une autre adresse IP en
changeant l'adresse IP dans les headers des paquets IP. Cette technique permet
d'échanger des paquets entre 2 domaines d'adresses. En général cette technique
est utilisée pour avoir une même adresse IP pour tout un réseau comme un 
intranet ou encore un réseau domestique. Dans ce réseau, toutes les interfaces
- même le routeur - auront une adresse privée. Le routeur dispose en plus de
cela de une ou plusieurs adresses publics avec lesquelles il est connecté à
internet. Une adresse privée est une adresse qui est utilisée à l'intérieur
d'un réseau local, indépendant de tout réseau externe. Les adresses privées
peuvent être choisies parmi les suivantes: 10.0.0.0/8, 172.16.0.0/12 ou
192.168.0.0/16.

Lorsqu'une interface envoie un paquet vers l'extérieur du réseau, le routeur
effectue plusieurs changements. Il traduit d'abord l'adresse privée en adresse
public et la met dans l'en-tête du paquet. Puis il change tous les checksums
qui tiennent compte de l'adresse IP. Enfin, il garde en mémoire dans une table,
 appelée table NAT la correspondance entre adresse privée/adresse public et le
protocole utilisé, comme ci-dessous.

Cela n'est cependant pas suffisant. En effet, lorsqu'un paquet arrivera de
l'extérieur du réseau,  et si toutes les interfaces utilisent la même adresse
public sans distinction supplémentaire, le routeur ne saura pas à quelle
interface envoyer le paquet et il sera donc perdu.

Une solution à ce problème existe pour les protocoles utilisant les ports comme
TCP et UDP. Le routeur ajoute une information supplémentaire dans la table qui
est le port source d'où vient le paquet. Les ports, qui sont implémentés dans
la couche transport (couche 4), sont des sortes de "portes" qui permettent de
communiquer avec un système d'exploitation. Le numéro de port est un numéro
choisit aléatoirement entre 1024 et 65535, les ports 0 à 1023 étant réservés
pour les serveurs qui "écoutent" pour des connexions entrantes.

Pour illustrer le fonctionnement du NAT imaginons qu'une interface A dont l'ip
est 192.168.0.1 veut envoyer un paquet TCP à l'interface B d'ip 217.70.184.38.
Le port source est le port 10277 et le port destination est le port 80. Le
routeur a l'adresse IP  82.240.25.50.

L'interface A envoie le paquet:

La box internet enverra le paquet:

L'interface B répondra en envoyant le paquet:

Finalement, la table NAT ressemblera à ceci:

<TABLE NAT 1 > 

Lorsque la box reçoit ce paquet, elle voit que le port de destination est le
port 10277. Elle cherche ensuite le port correspondant dans sa table NAT.
Lorsqu'elle le trouve elle effectue les changements nécessaire sur le paquet et
transmet le paquet à l'interface A.

Mais même si cette solution fonctionne la plupart du temps, la probabilité est
faible que 2 interfaces envoient des paquet sur les même port. C'est pour
éviter cela que la box change le port source lorsqu'elle reçoit un paquet de
l'interface A. Ainsi on s'assure que aucun port n'est utilisé plusieurs fois.
On obtient donc des tables de NAT comme dans l'exemple ci dessous:

On reprend les mêmes informations qu'avant. On a donc une interface A dont l'ip
est 192.168.0.1 veut envoyer un paquet TCP à l'interface B d'ip 217.70.184.38.
Le port source est le port 10277 et le port destination est le port 80. Le
routeur a l'adresse IP  82.240.25.50.
On y ajoute une interface C, sur le même réseau que A et qui veut également
envoyer un paquet TCP à la même adresse avec le même port source. L'IP de C
sera 192.168.1.2.
On obtient la table:
<TABLE NAT 2>

Enfin, pour éviter de saturer les ports utilisés il est nécessaire de recycler
 ceux qui ne sont plus utilisés. Lorsqu'on utilise un protocole comme UDP le
routeur n'a aucune possibilité de savoir si le transfert et terminé. Lorsqu'on
utilise une connexion TCP entre A et B, des messages de fin de session sont
envoyés par A et B lors de la fin du transfert. Lorsque la transmission est
finit, A envoie un message FIN à B qui lui répond par un message ACK et vice
versa. Mais ces messages ne sont pas utilisables pour reconnaître la fin de
connexion car lors de la réception de ce message il est toujours possible qu'un
paquet ai du être retransmit. Ainsi, on utilise un compteur de temps qui est
associé à chaque paire adresse public/adresse privée. Lorsqu'il n'y a pas de
trafic entre une adresse privée et l'extérieur durant une durée fixée, le port
qui lui est associée peut être réutilisé pour une autre adresse privée.


2) Différents types de NAT

Il existe différents types de NAT:
- Le NAT dynamique PAT (Port Address Translation du port source). Ici les
adresses externes sont indifférentes.
- Masquerading où il n'y a qu'une adresse IP, celle du routeur, qui est
utilisée comme adresse IP externe.
- NAT pool de source. Ici la première connexion privée prend la première
adresse ip externe, la deuxième prend la deuxième ip externe, etc.
- NAT pool de destination. Elle permet de répartir la charge entre plusieurs
serveurs.

PORT FORWARDING
Le NAT dynamique apporte cependant un grand problème. Lorsqu'une interface
extérieur veut se connecter à une interface dans le réseau, elle ne dispose
d'aucune autre information que l'adresse IP public. Si elle envoie alors un
paquet à cette adresse, le routeur qui le réceptionnera ne saura pas quoi en
faire car il ne sait pas à quelle interface le paquet est destiné et il sera
donc perdu. 

On a réussi à pallier à ce problème grâce à la redirection de port (port 
forwarding). 

Le principe du port forwarding est de rediriger tout paquet qui arrive sur un
port du routeur vers le port d'une interface locale. Les connexions le
nécessitant sont les connexions point à point.
Par exemple, prenons un routeur qui a comme IP externe 82.240.25.50.
Nous le réglons de façon qu'il redirige tout paquet arrivant sur son port 80
vers une interface locale A d'adresse locale 192.168.1.1.
Imaginons qu'une interface sur le réseau essaie de se connecter à cette adresse
 IP au port 80.
Lorsque le routeur reçoit le paquet il va le transmettre à l'interface A comme
dans le schéma ci-dessous:

<SCHEMA PORT FORWARDING> FAIT

Il est possible de faire du port forwarding sur plusieurs port et vers des
interfaces différentes simultanément.

NAT STATIQUE
Le NAT statique est l'attribution d'une adresse IP externe à une adresse IP 
privé. Grâce à cette méthode une interface sur un réseau privé peut avoir une
IP publique. Pour faire une traduction d'adresse statique il faut la configurer
manuellement dans la table de routage du routeur. Cette traduction restera dans
la table jusqu'à ce qu'elle soit supprimée. La traduction d'adresse statique
est le plus souvent utilisée pour interconnecter deux réseaux avec des
adressages différents.

4) NAT et sécurité

Même si ça n'a pas été le but de la traduction d'adresses, un des effets
secondaires du NAT a été d'apporter de la sécurité. En effet, auparavant, une
interface pouvait se connecter à n'importe quel port sur une machine du réseau,
à condition que ce port soit ouvert. Avec la traduction d'adresse, il n'est pas
possible d'atteindre n'importe quel port d'une interface. Il est uniquement
possible d'atteindre un port lorsqu'une connexion a été établit avec ce port
spécifique ou si le routeur cible a configuré l'interface cible comme interface
par défaut pour ce port.


\subsubsection{Solutions}
//NAT,IPv6
\subsection{Différence entre IPv4 et IPv6}

% MOSSI

Il est important de comprendre que l'IPv6 est beaucoup plus qu'une extension de
l'adressage IPv4. IPv6, d'abord défini dans la RFC 2460, est une mise en oeuvre
complète de la couche réseau de la pile TCP/IP et il couvre beaucoup plus que
l'extension de l'espace d'adressage simple à partir de 32 à 128 bits (le
mécanisme qui augmente la capacité d'IPv6 à allouer presque un nombre illimitée
d'adresses à tous les appareils dans le monde pour les années à venir).IPv6
offre de nombreuses améliorations par rapport à IPv4, et le tableau ci-dessous
compare le fonctionnement de IPv4 et de IPv6.

Systéme de routage beaucoup plus efficace. Les paquets IPv6 ne sont plus
fragmenté par les routeurs.
	
La qualité de service(QoS) intégrée. Alors que IPv4 n'a aucun moyen de
distinguer les paquets sensibles au retard de transferts de données en vrac, ce
qui nécessite de nombreuses solutions de contournement, mais IPv6 le fait.
	
L'élimination du NAT pour élargir les espaces d'adressage. IPv6 augmente la
taille de l'adresse IPv4 de 32 bits (environ 4 milliards) à 128 bits
(suffisamment pour chaque molécule dans le système solaire).
	
La sécurité de la couche réseau intégré (IPsec). La sécurité a toujours été
un défi en IPv4, mais elle est une partie intégrante de l'IPv6.
	
L'autoconfiguration d'adresse pour l'administration réseau plus facile. De
nombreux installations IPv4 ont été compliquées par le routeur par défaut
manuelle et l'attribution d'adresse. IPv6 gère cela de manière automatisée.
	
L'amélioration de la structure d'en-tête permet d'alléger le traitement. La
plupart des champs dans l'en-tête IPv4 étaient facultatifs et utilisés
fréquemment. IPv6 élimine ces champs (les options sont traitées différemment).
